# -*- coding: utf-8 -*-
"""
ูุดู ุงูุชูุฑุงุฑุงุช - ุฎุทูุฉ ุจุฎุทูุฉ
"""

from core.data_loader import DataLoader
from core.duplicate_analyzer import DuplicateAnalyzer

print("="*80)
print("๐ ูุดู ุงูุชูุฑุงุฑุงุช - ุฎุทูุฉ ุจุฎุทูุฉ")
print("="*80)

# ============================================================================
# ุงูุฎุทูุฉ 1: ุชุญููู ุงูุจูุงูุงุช
# ============================================================================
print("\n๐ฅ ุงูุฎุทูุฉ 1: ุชุญููู ุงูุจูุงูุงุช...")
print("-" * 80)

loader = DataLoader('ุงูุนุฌูุฑู 11-4.csv')
df = loader.load()

print(f"โ ุชู ุชุญููู {len(df):,} ุตู ู {len(df.columns)} ุนููุฏ")
print(f"\n๐ ุฃุณูุงุก ุงูุฃุนูุฏุฉ:")
for i, col in enumerate(df.columns, 1):
    print(f"   {i:2d}. {col}")

input("\nโธ๏ธ  ุงุถุบุท Enter ูููุชุงุจุนุฉ ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ...")

# ============================================================================
# ุงูุฎุทูุฉ 2: ุชูุธูู ุงูุจูุงูุงุช
# ============================================================================
print("\n" + "="*80)
print("๐งน ุงูุฎุทูุฉ 2: ุชูุธูู ุงูุจูุงูุงุช...")
print("-" * 80)

loader.auto_clean()
df = loader.get_data()

print(f"โ ุจุนุฏ ุงูุชูุธูู: {len(df):,} ุตู ู {len(df.columns)} ุนููุฏ")
print(f"\n๐ ุงูุฃุนูุฏุฉ ุจุนุฏ ุงูุชูุธูู:")
for i, col in enumerate(df.columns, 1):
    null_pct = df[col].isnull().sum() / len(df) * 100
    print(f"   {i:2d}. {col:30s} - ููู ูุงุฑุบุฉ: {null_pct:.1f}%")

input("\nโธ๏ธ  ุงุถุบุท Enter ูููุชุงุจุนุฉ ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ...")

# ============================================================================
# ุงูุฎุทูุฉ 3: ุนุฑุถ ุนููุฉ ูู ุงูุจูุงูุงุช
# ============================================================================
print("\n" + "="*80)
print("๐ ุงูุฎุทูุฉ 3: ุนุฑุถ ุนููุฉ ูู ุงูุจูุงูุงุช...")
print("-" * 80)

print("\n๐ ุฃูู 5 ุตููู:")
# ุนุฑุถ ุงูุฃุนูุฏุฉ ุงูุฃุณุงุณูุฉ ููุท
display_cols = ['OwnerName', 'EntryTypeNumber', 'Race', 'Season']
available_cols = [col for col in display_cols if col in df.columns]
if available_cols:
    print(df[available_cols].head(5).to_string(index=False))
else:
    print(df.head(5).to_string(index=False))

input("\nโธ๏ธ  ุงุถุบุท Enter ูููุชุงุจุนุฉ ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ...")

# ============================================================================
# ุงูุฎุทูุฉ 4: ุชุญุฏูุฏ ุงูุฃุนูุฏุฉ ููุชุญููู
# ============================================================================
print("\n" + "="*80)
print("๐ฏ ุงูุฎุทูุฉ 4: ุชุญุฏูุฏ ุงูุฃุนูุฏุฉ ููุชุญููู...")
print("-" * 80)

# ุงุฎุชูุงุฑ ุฃุนูุฏุฉ ููุงุณุจุฉ ููุชุญููู
print("\n๐ ุงุฎุชูุงุฑ ุงูุฃุนูุฏุฉ:")

# ุนุฑุถ ุงูุฃุนูุฏุฉ ุงููุชุงุญุฉ
print("\nุงูุฃุนูุฏุฉ ุงููุชุงุญุฉ:")
for i, col in enumerate(df.columns, 1):
    print(f"   {i:2d}. {col}")

# ุชุญุฏูุฏ ุงูุฃุนูุฏุฉ ุชููุงุฆูุงู
entity_col = 'OwnerName'  # ุนููุฏ ุงูุฌูุฉ
amount_col = 'EntryTypeNumber'  # ุนููุฏ ุงููุจูุบ (ุฑููู)
event_col = 'Race'  # ุนููุฏ ุงูุญุฏุซ

print(f"\nโ ุงูุฃุนูุฏุฉ ุงููุฎุชุงุฑุฉ:")
print(f"   โข ุนููุฏ ุงูุฌูุฉ: {entity_col}")
print(f"   โข ุนููุฏ ุงููุจูุบ: {amount_col}")
print(f"   โข ุนููุฏ ุงูุญุฏุซ: {event_col}")

input("\nโธ๏ธ  ุงุถุบุท Enter ูููุชุงุจุนุฉ ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ...")

# ============================================================================
# ุงูุฎุทูุฉ 5: ุงูุจุญุซ ุนู ุงูุชูุฑุงุฑุงุช
# ============================================================================
print("\n" + "="*80)
print("๐ ุงูุฎุทูุฉ 5: ุงูุจุญุซ ุนู ุงูุชูุฑุงุฑุงุช...")
print("-" * 80)

analyzer = DuplicateAnalyzer(df)

print("\nโณ ุฌุงุฑู ุงูุจุญุซ...")
duplicates = analyzer.find_payment_duplicates(
    entity_col=entity_col,
    amount_col=amount_col,
    event_col=event_col
)

print(f"\nโ ุงูุชูู ุงูุจุญุซ!")
print(f"\n๐ ุงููุชุงุฆุฌ:")
print(f"   โข ุฅุฌูุงูู ุงูุณุฌูุงุช: {len(df):,}")
print(f"   โข ุนุฏุฏ ุงูุชูุฑุงุฑุงุช: {len(duplicates):,}")
print(f"   โข ูุณุจุฉ ุงูุชูุฑุงุฑ: {len(duplicates)/len(df)*100:.2f}%")

if len(duplicates) > 0:
    print(f"   โข ุนุฏุฏ ุงููุฌููุนุงุช ุงูููุฑุฑุฉ: {duplicates['duplicate_group'].nunique()}")
    
    input("\nโธ๏ธ  ุงุถุบุท Enter ูุนุฑุถ ุงูุชูุฑุงุฑุงุช...")
    
    # ============================================================================
    # ุงูุฎุทูุฉ 6: ุนุฑุถ ุงูุชูุฑุงุฑุงุช
    # ============================================================================
    print("\n" + "="*80)
    print("๐ ุงูุฎุทูุฉ 6: ุนุฑุถ ุงูุชูุฑุงุฑุงุช...")
    print("-" * 80)
    
    # ุนุฑุถ ุฃูู 20 ุชูุฑุงุฑ
    print("\n๐ ุฃูู 20 ุชูุฑุงุฑ:")
    display_cols = [entity_col, amount_col, event_col, 'duplicate_group', 'duplicate_count']
    print(duplicates[display_cols].head(20).to_string())
    
    # ุฅุญุตุงุฆูุงุช ุงููุฌููุนุงุช
    print("\n๐ ุฅุญุตุงุฆูุงุช ุงููุฌููุนุงุช:")
    group_stats = duplicates.groupby('duplicate_group').agg({
        entity_col: 'first',
        amount_col: 'first',
        'duplicate_count': 'first'
    }).sort_values('duplicate_count', ascending=False)
    
    print("\n๐ ุฃูุซุฑ 10 ูุฌููุนุงุช ุชูุฑุงุฑุงู:")
    print(group_stats.head(10).to_string())
    
    input("\nโธ๏ธ  ุงุถุบุท Enter ูููุชุงุจุนุฉ ุฅูู ุงูุชุตุฏูุฑ...")
    
    # ============================================================================
    # ุงูุฎุทูุฉ 7: ุชุตุฏูุฑ ุงููุชุงุฆุฌ
    # ============================================================================
    print("\n" + "="*80)
    print("๐พ ุงูุฎุทูุฉ 7: ุชุตุฏูุฑ ุงููุชุงุฆุฌ...")
    print("-" * 80)
    
    output_file = 'outputs/duplicates_detailed_report.xlsx'
    analyzer.export_duplicates(output_file)
    
    print(f"\nโ ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุจูุฌุงุญ!")
    print(f"๐ ุงููููุน: {output_file}")
    
else:
    print("\nโ ูู ูุชู ุงูุนุซูุฑ ุนูู ุชูุฑุงุฑุงุช!")

# ============================================================================
# ุงูุฎุทูุฉ 8: ุงูุจุญุซ ุนู ุชุทุงุจู ุถุจุงุจู (ุงุฎุชูุงุฑู)
# ============================================================================
print("\n" + "="*80)
print("๐ ุงูุฎุทูุฉ 8: ุงูุจุญุซ ุนู ุชุทุงุจู ุถุจุงุจู (ุฃุณูุงุก ูุชุดุงุจูุฉ)...")
print("-" * 80)

print("\nโณ ุฌุงุฑู ุงูุจุญุซ ุนู ุฃุณูุงุก ูุชุดุงุจูุฉ...")
fuzzy_matches = analyzer.find_fuzzy_duplicates(
    name_col=entity_col,
    threshold=0.90  # 90% ุชุดุงุจู ุฃู ุฃูุซุฑ
)

if len(fuzzy_matches) > 0:
    print(f"\nโ ุชู ุงูุนุซูุฑ ุนูู {len(fuzzy_matches)} ุชุทุงุจู ุถุจุงุจู")
    print("\n๐ ุฃูุซูุฉ ุนูู ุงูุฃุณูุงุก ุงููุชุดุงุจูุฉ:")
    count = 0
    for idx, row in fuzzy_matches.head(10).iterrows():
        count += 1
        print(f"\n   {count}. ุงูุชุทุงุจู:")
        print(f"      โข ุงูุงุณู 1: {row['original_name1']}")
        print(f"      โข ุงูุงุณู 2: {row['original_name2']}")
        print(f"      โข ูุณุจุฉ ุงูุชุดุงุจู: {row['similarity']*100:.1f}%")
else:
    print("\nโ ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุทุงุจูุงุช ุถุจุงุจูุฉ")

# ============================================================================
# ุงูููุงูุฉ
# ============================================================================
print("\n" + "="*80)
print("โ ุงูุชูู ุงูุชุญููู ุจูุฌุงุญ!")
print("="*80)
print("\n๐ ุงูููุฎุต:")
print(f"   โข ุชู ุชุญููู: {len(df):,} ุณุฌู")
print(f"   โข ุชูุฑุงุฑุงุช ุชุงูุฉ: {len(duplicates):,}")
if len(fuzzy_matches) > 0:
    print(f"   โข ุชุทุงุจูุงุช ุถุจุงุจูุฉ: {len(fuzzy_matches)}")
print(f"\n๐ ุงูุชูุงุฑูุฑ ูุญููุธุฉ ูู ูุฌูุฏ: outputs/")
print("\n๐ ููุงุณุชุฎุฏุงู ุงูุชูุงุนูู: http://localhost:8501")
print("\n")
